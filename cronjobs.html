

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cron Jobs &#8212; My Homeserver</title>
    
    <link rel="stylesheet" href="_static/marcelene.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Convenience" href="convenience.html" />
    <link rel="prev" title="Services" href="services.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="index.html">My Homeserver</a></div>
        <div class="rel">
          <a href="services.html" title="Services"
             accesskey="P">previous</a> |
          <a href="convenience.html" title="Convenience"
             accesskey="N">next</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="cron-jobs">
<h1>Cron Jobs<a class="headerlink" href="#cron-jobs" title="Permalink to this headline">¶</a></h1>
<p>I do have a few scripts,
which cron should execute regularly.
For safety, let us wall them off.</p>
<p>First, a separate user called cronbot.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">adduser</span> <span class="o">--</span><span class="n">disabled</span><span class="o">-</span><span class="n">password</span> <span class="n">cronbot</span>
</pre></div>
</div>
<p>This guide is not about my scripts,
so I will just use a dummy script here.
As user cronbot create <code class="docutils literal"><span class="pre">~/example.sh</span></code>.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&gt;~/</span><span class="n">example</span><span class="o">.</span><span class="n">sh</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="c1">#!/bin/sh</span>
<span class="nb">set</span> <span class="o">-</span><span class="n">e</span>
<span class="n">exec</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="n">echo</span> <span class="s2">&quot;Success!&quot;</span>
<span class="n">EOF</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">~/</span><span class="n">example</span><span class="o">.</span><span class="n">sh</span>
<span class="o">~/</span><span class="n">example</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>I use anacron, because it is simpler to dump scripts into <code class="docutils literal"><span class="pre">/etc/cron.hourly</span></code>.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">anacron</span> <span class="n">cronic</span>
</pre></div>
</div>
<div class="section" id="only-mail-on-failure">
<h2>Only Mail on Failure<a class="headerlink" href="#only-mail-on-failure" title="Permalink to this headline">¶</a></h2>
<p>Since I enabled email notifications,
cron spams a lot.
We only want mail,
if something goes wrong.
Cron violates the <a class="reference external" href="https://en.wikipedia.org/wiki/Unix_philosophy">rule of silence</a>.</p>
<p>The solution:
Cron sends mail, if there was output from stdout or stderr,
so we must silence the script.
The <a class="reference external" href="http://habilis.net/cronic/">cronic</a> wrapper is available via apt,
but it has a wrong idea about stderr output meaning failure.</p>
<blockquote>
<div>Cronic is a small shim shell script for wrapping cron jobs
so that cron only sends email when an error has occurred.
Cronic defines an error as any non-trace error output or a non-zero result code.</div></blockquote>
<p>While stderr sounds like it is for errors,
it is actually for meta output in general.
Fortunately, we can redirect stderr to stdout,
then cronic can only rely on the result code,
which is correct.
This is the reason for the <code class="docutils literal"><span class="pre">exec</span> <span class="pre">2&gt;&amp;1</span></code> line in the <code class="docutils literal"><span class="pre">example.sh</span></code> script.</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Put the following script into <code class="docutils literal"><span class="pre">/etc/cron.hourly/example</span></code>.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="n">su</span> <span class="o">-</span> <span class="n">cronbot</span> <span class="o">--</span> <span class="n">cronic</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cronbot</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>To check log files,
when your script has run,
use journalctl.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">cron</span>
</pre></div>
</div>
</div>
<div class="section" id="longterm">
<h2>Longterm<a class="headerlink" href="#longterm" title="Permalink to this headline">¶</a></h2>
<p>I do not like cron and I want to replace it.
For now it works.
On issue is efficiency.
For the example above, there is</p>
<ul class="simple">
<li>at the top <code class="docutils literal"><span class="pre">cron</span></code>, which</li>
<li>executes <code class="docutils literal"><span class="pre">anacron</span></code>, which</li>
<li>executes <code class="docutils literal"><span class="pre">/etc/cron.hourly/example</span></code>, which</li>
<li>executes <code class="docutils literal"><span class="pre">cronic</span></code>, which</li>
<li>executes <code class="docutils literal"><span class="pre">/home/cronbot/example.sh</span></code>.</li>
</ul>
<p>In this stack, anacron and cronic are crutches for cron shortcomings.</p>
<p>One alternative could be systemd,
which includes <a class="reference external" href="https://wiki.archlinux.org/index.php/Systemd/Timers">timers</a>.
They can be misused as a cron replacement,
but it is obviously a workaround,
especially if you want to get mail on failure.</p>
<p>Maybe <a class="reference external" href="https://dshearer.github.io/jobber/">jobber</a> could be worthwhile.
While I dislike the YAML syntax,
it seems to be fine in its general design.</p>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="os.html">Operating System</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardening.html">Hardening</a></li>
<li class="toctree-l1"><a class="reference internal" href="notifications.html">Notifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="dyndns.html">Dynamic DNS</a></li>
<li class="toctree-l1"><a class="reference internal" href="nextcloud.html">NextCloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Cron Jobs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#only-mail-on-failure">Only Mail on Failure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#longterm">Longterm</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="convenience.html">Convenience</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="fineprint.html">Fineprint</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="services.html" title="Services"
             >previous</a> |
          <a href="convenience.html" title="Convenience"
             >next</a>
            <br/>
            <a href="_sources/cronjobs.rst.txt"
               rel="nofollow">Show Source</a>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Andreas Zwinkau.
      Last updated on 2017-05-22.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.1.
    </div>
        </div>
        <div class="clearer"></div>
        <div id="feedback">
          For feedback <a href="mailto:qznc@web.de">write me an email to qznc@web.de</a>.
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>