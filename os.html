

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Operating System &#8212; My Homeserver</title>
    
    <link rel="stylesheet" href="_static/marcelene.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Hardening" href="hardening.html" />
    <link rel="prev" title="Introduction" href="intro.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="index.html">My Homeserver</a></div>
        <div class="rel">
          <a href="intro.html" title="Introduction"
             accesskey="P">previous</a> |
          <a href="hardening.html" title="Hardening"
             accesskey="N">next</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="operating-system">
<h1>Operating System<a class="headerlink" href="#operating-system" title="Permalink to this headline">¶</a></h1>
<p>I will use Ubuntu Server LTS 16.04.
Ubuntu is widely used operating system,
which means it is relatively easy to get help online.
It also gives 5 years of security updates for LTS versions,
which is important if we want to let the server run unattended for years.</p>
<div class="section" id="docker-playground">
<h2>Docker Playground<a class="headerlink" href="#docker-playground" title="Permalink to this headline">¶</a></h2>
<p>Assuming you have docker installed,
a sandbox for playing around is simple.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">it</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">16.04</span> <span class="n">bash</span>
</pre></div>
</div>
<p>Docker is more restrictive than realistic for a real server, though.
So a virtual machine via QEMU is better.</p>
</div>
<div class="section" id="qemu-playground">
<h2>QEMU Playground<a class="headerlink" href="#qemu-playground" title="Permalink to this headline">¶</a></h2>
<p>First, we fetch an Ubuntu image.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">O</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">releases</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="mf">16.04</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">-</span><span class="mf">16.04</span><span class="o">.</span><span class="mi">2</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
<p>This is the “installation CD”.
Now we install Ubuntu to a base harddisk image of 4GiB.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">img</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">qcow2</span> <span class="n">ubuntu</span><span class="o">-</span><span class="n">base</span><span class="o">.</span><span class="n">img</span> <span class="mi">4</span><span class="n">G</span>
<span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span> <span class="o">-</span><span class="n">hda</span> <span class="n">ubuntu</span><span class="o">-</span><span class="n">base</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">cdrom</span> <span class="n">ubuntu</span><span class="o">-</span><span class="mf">16.04</span><span class="o">.</span><span class="mi">2</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">boot</span> <span class="n">d</span> <span class="o">-</span><span class="n">enable</span><span class="o">-</span><span class="n">kvm</span> <span class="o">-</span><span class="n">m</span> <span class="mi">1</span><span class="n">G</span>
</pre></div>
</div>
<p>Enabling KVM makes stuff faster.
The default of 128MiB RAM is not enough,
so we set RAM to 1GiB.</p>
<p>Go through the installation process.
Personally, I use english as a language,
but a german timezone and keyboard layout.</p>
<p>We do not want to modify this base image,
so we can easily reset it.
Then we can play around without remorse.
We use qemu-img to create another image <em>based on</em> the stock Ubuntu.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">img</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">qcow2</span> <span class="o">-</span><span class="n">b</span> <span class="n">ubuntu</span><span class="o">-</span><span class="n">base</span><span class="o">.</span><span class="n">img</span> <span class="n">playground</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
<p>Now we can boot into the playground.
Again we use <code class="docutils literal"><span class="pre">-enable-kvm</span> <span class="pre">-m</span> <span class="pre">1G</span></code>.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span> <span class="o">-</span><span class="n">hda</span> <span class="n">playground</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">enable</span><span class="o">-</span><span class="n">kvm</span> <span class="o">-</span><span class="n">m</span> <span class="mi">1</span><span class="n">G</span>
</pre></div>
</div>
<p>For quick throw-away experiments,
which are not supposed to be permanent,
you can skip the img-create step via <code class="docutils literal"><span class="pre">-snapshot</span></code>.
Here qemu will not modify the <code class="docutils literal"><span class="pre">playground.img</span></code>.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span> <span class="o">-</span><span class="n">hda</span> <span class="n">playground</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">enable</span><span class="o">-</span><span class="n">kvm</span> <span class="o">-</span><span class="n">m</span> <span class="mi">1</span><span class="n">G</span> <span class="o">-</span><span class="n">snapshot</span>
</pre></div>
</div>
<div class="section" id="headless-server">
<h3>Headless Server<a class="headerlink" href="#headless-server" title="Permalink to this headline">¶</a></h3>
<p>For a more realistic feeling,
we can disable qemu’s virtual display.
Instead, we ssh into the guest system.
Boot it with <code class="docutils literal"><span class="pre">-nographic</span></code> and some port forwarding:</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span> <span class="o">-</span><span class="n">hda</span> <span class="n">playground</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">enable</span><span class="o">-</span><span class="n">kvm</span> <span class="o">-</span><span class="n">m</span> <span class="mi">1</span><span class="n">G</span> <span class="o">-</span><span class="n">nographic</span> <span class="o">-</span><span class="n">net</span> <span class="n">user</span><span class="p">,</span><span class="n">hostfwd</span><span class="o">=</span><span class="n">tcp</span><span class="p">::</span><span class="mi">7777</span><span class="o">-</span><span class="p">:</span><span class="mi">22</span> <span class="o">-</span><span class="n">net</span> <span class="n">nic</span>
</pre></div>
</div>
<p>Now on the host,
use ssh to port 7777.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">p</span> <span class="mi">7777</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="converting-a-desktop-ubuntu">
<h2>Converting a Desktop Ubuntu<a class="headerlink" href="#converting-a-desktop-ubuntu" title="Permalink to this headline">¶</a></h2>
<p>With my laptop-to-homeserver conversion,
there is a full desktop system running.
It might be nice,
to access the server directly with a GUI,
but a few things are removed nonetheless.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">remove</span> <span class="n">google</span><span class="o">-</span><span class="n">chrome</span> <span class="n">gnucash</span> <span class="c1">#...</span>
</pre></div>
</div>
<p>NetworkManager provides a DNS resolver on port 53.
To disable this,
edit <code class="docutils literal"><span class="pre">/etc/NetworkManager/NetworkManager.conf</span></code>
and comment out the <code class="docutils literal"><span class="pre">dns=dnsmasq</span></code> line.
Then restart NetworkManager.
Afterwards the port is free and
we could setup our own DNS server.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">NetworkManager</span>
</pre></div>
</div>
</div>
<div class="section" id="networking">
<h2>Networking<a class="headerlink" href="#networking" title="Permalink to this headline">¶</a></h2>
<p>My router is responsible for the IP addresses,
so the home server must get one by DHCP.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">isc</span><span class="o">-</span><span class="n">dhcp</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>Afterwards, networking should work.
However, qemu only allows TCP and UDP by default,
so ping does not work.
Instead we try an update.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">update</span>
</pre></div>
</div>
</div>
<div class="section" id="time">
<h2>Time<a class="headerlink" href="#time" title="Permalink to this headline">¶</a></h2>
<p>Our server should stay in sync automatically,
so we use NTP.
It should be installed by default.
Check via:</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">timedatectl</span> <span class="n">status</span>
</pre></div>
</div>
</div>
<div class="section" id="ssh">
<h2>SSH<a class="headerlink" href="#ssh" title="Permalink to this headline">¶</a></h2>
<p>We maintain the server via ssh.
If you did not select it during installation, do it now.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">openssh</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</div>
<div class="section" id="trimming">
<h2>Trimming<a class="headerlink" href="#trimming" title="Permalink to this headline">¶</a></h2>
<p>Ubuntu is actually too generous in my opinion.
This is why I remove a few packages.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">remove</span> <span class="n">byobu</span> <span class="n">info</span> <span class="n">tcpdump</span> <span class="n">telnet</span> <span class="n">tasksel</span> <span class="n">screen</span> <span class="n">laptop</span><span class="o">-</span><span class="n">detect</span> <span class="n">ftp</span> <span class="n">fuse</span> <span class="n">install</span><span class="o">-</span><span class="n">info</span> <span class="n">plymouth</span> <span class="n">xauth</span>
</pre></div>
</div>
<p>This also removes packages like <code class="docutils literal"><span class="pre">ubuntu-server</span></code>,
which is ok,
because these are empty and only used to pull in other packages.</p>
</div>
<div class="section" id="snap">
<h2>Snap<a class="headerlink" href="#snap" title="Permalink to this headline">¶</a></h2>
<p>For installing software,
I like the Ubuntu Snap system.</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">snapd</span>
</pre></div>
</div>
</div>
<div class="section" id="ubuntu-server">
<h2>Ubuntu Server<a class="headerlink" href="#ubuntu-server" title="Permalink to this headline">¶</a></h2>
<p>The desktop Ubuntu was 32bit,
although it is a 64bit processor.
When I tried to convert the system,
I broke apt.
Then I installed Ubuntu from scratch.</p>
<p>Another mistake was to enabled home directory encryption.
That is not a good idea,
if you want to login with an ssh public key.
The ssh server cannot access the <code class="docutils literal"><span class="pre">authorized_keys</span></code> file,
if it is encrypted.</p>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Operating System</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#docker-playground">Docker Playground</a></li>
<li class="toctree-l2"><a class="reference internal" href="#qemu-playground">QEMU Playground</a></li>
<li class="toctree-l2"><a class="reference internal" href="#converting-a-desktop-ubuntu">Converting a Desktop Ubuntu</a></li>
<li class="toctree-l2"><a class="reference internal" href="#networking">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="#time">Time</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ssh">SSH</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trimming">Trimming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#snap">Snap</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ubuntu-server">Ubuntu Server</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hardening.html">Hardening</a></li>
<li class="toctree-l1"><a class="reference internal" href="notifications.html">Notifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="dyndns.html">Dynamic DNS</a></li>
<li class="toctree-l1"><a class="reference internal" href="nextcloud.html">NextCloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="cronjobs.html">Cron Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="convenience.html">Convenience</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="fineprint.html">Fineprint</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="intro.html" title="Introduction"
             >previous</a> |
          <a href="hardening.html" title="Hardening"
             >next</a>
            <br/>
            <a href="_sources/os.rst.txt"
               rel="nofollow">Show Source</a>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Andreas Zwinkau.
      Last updated on 2017-05-22.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.1.
    </div>
        </div>
        <div class="clearer"></div>
        <div id="feedback">
          For feedback <a href="mailto:qznc@web.de">write me an email to qznc@web.de</a>.
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>